{% extends "layout.html" %}

{% block title %}
    Range Booking
{% endblock %}

{% block main %}
<div class="container-fluid px-5">
    
    <form action="/booking/range" method="post">
        
        <div class="row">
            <h1 class="text-left display-3 fw-bold mt-4 mb-5">
                Range Booking
            </h1>

            <div class="col-lg-7 col-md-12">
    
                <div class="row align-items-end mb-4">
                    
                    <div class="col-md-3">
                        <label for="date-selector" class="form-label fw-bold">Date</label>
                        <input type="date" id="date-selector" name="booking-date" class="form-select">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="time-selector" class="form-label fw-bold">Time</label>
                        <select id="time-selector" class="form-select" name="booking-time">
                            <option value="07:00">7:00 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <p class="h5 fw-bold mb-0" id="session-status"></p>
                    </div>
                </div>

                <hr>

                <div class="row mb-4">
                    <label for="bucketCount" class="form-label fw-bold">Buckets of golf balls</label>
                    <div class="count-cointainer" id="bucketCount">
                        <button type="button" class="btn-counter" id="decreaseBtn" aria-label="Decrease quantity">
                            &minus;
                        </button>
                        
                        <span class="display-count" id="bucketsAmount">1</span>
                        
                        <button type="button" class="btn-counter" id="increaseBtn" aria-label="Increase quantity">
                            &plus;
                        </button>
                        
                        <input type="hidden" name="buckets-value" id="hiddenValue" value="1">
                    </div>
                </div>

                <hr>
                
                <div class="row mb-4">
                    <label for="coach-selector" class="form-label fw-bold">Coach</label>
                    <div class="col-md-12">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <select class="form-select" name="booking-coach" id="coach-selector">
                                    <option value="0">No Coach</option>
                                    {% for co in coach %}
                                        <option value="{{ co.staff_id }}" data-status="{{ co.status }}" fee="{{ co.service_fee }}">
                                            {{ co.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-4">
                                <p class="h5 fw-bold mb-0" id="coach-availability"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

            </div>

            <div class="col-lg-5 col-md-12">
                <div class="border rounded p-4">
                    <h3 class="mb-4">Order Summary</h3>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Range</span>
                        <strong>₱1000</strong>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Buckets</span>
                        <strong id="buckets-price">₱300</strong>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Coach</span>
                        <strong id="coach-price">₱0</strong>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between h4 fw-bold my-3">
                        <span>Total</span>
                        <span id ="total-price">₱1300</span>
                    </div>
                    
                    <button class="btn btn-green w-100" type="submit">Checkout Now</button>
                </div>
            </div>

        </div> 
    </form> 
</div> 

<script>

    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const displayAmount = document.getElementById('bucketsAmount');
    const realAmount = document.getElementById('hiddenValue');
    
    const dateSelector = document.getElementById('date-selector');
    const timeSelector = document.getElementById('time-selector');
    const sessionStatusText = document.getElementById('session-status');
    const coachSelector = document.getElementById('coach-selector');


    function updateQuantity(addend) {
        let curVal = parseInt(displayAmount.textContent); 
        let newVal = curVal + addend;

        if (newVal < 1) {
            newVal = 1;
        }
        
        displayAmount.textContent = newVal;
        realAmount.value = newVal; 

        updateTotal();
    }

    async function checkSession() {
        const dateVal = dateSelector.value;
        const timeVal = timeSelector.value;

        if (!dateVal || !timeVal) {
            sessionStatusText.textContent = "Select Date";
            sessionStatusText.className = "h5 fw-bold text-muted mb-0 pb-1";
            return;
        }

        sessionStatusText.textContent = "Checking...";
        sessionStatusText.className = "h5 fw-bold text-muted mb-0 pb-1";

        try {
            const url = `/api/check_session_status?date=${dateVal}&time=${timeVal}&type=Driving Range`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.status === 'Available') {
                sessionStatusText.textContent = 'Available';
                sessionStatusText.className = 'h5 fw-bold text-success mb-0 pb-1';
            } else if (data.status === 'Already Booked') {
                sessionStatusText.textContent = 'Already Booked';
                sessionStatusText.className = 'h5 fw-bold text-success mb-0 pb-1';
            } else {
                sessionStatusText.textContent = data.status;
                sessionStatusText.className = 'h5 fw-bold text-danger mb-0 pb-1';
            }
        } catch (error) {
            console.error(error);
            sessionStatusText.textContent = "Error";
        }
    }

    async function checkStaff(selectorId, availabilityId, textID) {
        const selector = document.getElementById(selectorId);
        const availabilityText = document.getElementById(availabilityId);
        const staffPriceText = document.getElementById(textID);
        
        const selectedOption = selector.options[selector.selectedIndex];
        const selectedStaffId = selectedOption.value;
        const staffPrice = parseFloat(selectedOption.getAttribute('fee')) || 0;

        if (selectedStaffId === "0") {
            availabilityText.textContent = ""; 
            staffPriceText.textContent = `₱0`;
            updateTotal(); 
            return; 
        }

        // B. Validate Date/Time
        const dateVal = dateSelector.value;
        const timeVal = timeSelector.value;

        if (!dateVal || !timeVal) {
            availabilityText.textContent = "Select Date & Time";
            availabilityText.className = "h5 fw-bold text-muted mb-0";
            staffPriceText.textContent = `₱${staffPrice}`;
            updateTotal();
            return;
        }

        // Call API
        availabilityText.textContent = "Checking...";
        availabilityText.className = "h5 fw-bold text-muted mb-0";

        try {
            const datetime = `${dateVal} ${timeVal}:00`;
            const response = await fetch(`/api/check_staff_availability?staff_id=${selectedStaffId}&datetime=${datetime}`);
            const data = await response.json();

            if (data.available) {
                availabilityText.textContent = 'Available';
                availabilityText.className = 'h5 fw-bold text-success mb-0';
            } else {
                availabilityText.textContent = 'Occupied'; 
                availabilityText.className = 'h5 fw-bold text-danger mb-0';
            }
        } catch (error) {
            console.error(error);
            availabilityText.textContent = 'Error'; 
            availabilityText.className = "h5 fw-bold text-danger mb-0";
        }

        staffPriceText.textContent = `₱${staffPrice}`;
        updateTotal();
    }

    function updateTotal() {
        const totalText = document.getElementById('total-price');
        const bucketsText = document.getElementById("buckets-price");

        const currentQuantity = parseInt(realAmount.value) || 1;
        
        // (300 per bucket)
        const bucketsPrice = currentQuantity * 300;
        
        const coachOption = coachSelector.options[coachSelector.selectedIndex];
        const coachPrice = (coachOption.value !== "0") ? parseFloat(coachOption.getAttribute('fee')) : 0;

        const total = bucketsPrice + coachPrice + 1000;

        bucketsText.textContent = `₱${bucketsPrice}`;
        totalText.textContent = `₱${total}`;
    }

    // EVENT LISTENERS

    // Buckets Buttons
    increaseBtn.addEventListener('click', () => updateQuantity(1));
    decreaseBtn.addEventListener('click', () => updateQuantity(-1));

    // If Staff changes, check availability
    coachSelector.addEventListener('change', () => {
        checkStaff('coach-selector', 'coach-availability', 'coach-price');
        checkSession();
    });

    // Date/Time Changes (Re-check staff availability)
    dateSelector.addEventListener('change', () => {
        checkStaff('coach-selector', 'coach-availability', 'coach-price');
        checkSession();
    });
    timeSelector.addEventListener('change', () => {
        checkStaff('coach-selector', 'coach-availability', 'coach-price');
        checkSession();
    });

    updateTotal(); 
    checkSession();
    checkStaff('coach-selector', 'coach-availability', 'coach-price');
</script>
{% endblock %}
