{% extends "layout.html" %}

{% block title %}
    Checkout
{% endblock %}

{% block main %}
<div class="container">
    <h1 class="my-5"><strong>Checkout</strong></h1>
    <div class="row">
        <div class="col-md-5 d-flex flex-column gap-3">
            <div class="d-flex">
                <div>Membership Fee</div>
                <div class="ms-auto"><strong>{{ membership_fee | php }}</strong></div>
            </div>
            <div class="d-flex">
                <div>Session Total Fee</div>
                <div class="ms-auto"><strong>{{ session_fee | php }}</strong></div>
            </div>

            {% if session_details %}
                <div class="d-flex flex-column mb-2 border-start border-3 ps-2 ms-1 mt-1">
                    {% for session in session_details %}
                    <div class="d-flex text-muted" style="font-size: 0.85rem;">
                        <div>
                            {{ session.type }}
                            <span class="d-block fst-italic" style="font-size: 0.75rem;">{{ session.schedule }}</span>
                        </div>
                        <div class="ms-auto">{{ session.price | php }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="d-flex">
                <div>Cart Total Fee</div>
                <div class="ms-auto"><strong>{{ cart_fee | php }}</strong></div>
            </div>

            <hr class="my-2">

            <div class="d-flex">
                <span class="fs-5">Sub Total</span>
                <div class="fs-5 ms-auto"><strong>{{ subtotal | php }}</strong></div>
            </div>

            <hr class="my-2">

            <div class="d-flex">
                <div>Membership Discount ({{ discount_percent }}%)</div>
                <div class="ms-auto"><strong>-{{ discount_amount | php }}</strong></div>
            </div>
            <div class="d-flex">
                <div>Loyalty Points Discount ({{ loyalty_points_used }} pts)</div>
                <div class="ms-auto"><strong>-{{ loyalty_points_discount | php }}</strong></div>
            </div>

            <hr class="my-2">

            <div class="d-flex">
                <span class="fs-4"><strong>Total</strong></span>
                <div class="fs-4 ms-auto"><strong>{{ total | php }}</strong></div>
            </div>


        </div>

        <div class="col-auto d-flex"> <div class="vr py-5"></div> </div>
            
        <div class="col-md-6 d-flex flex-column gap-1">
            <form method="POST" action="/checkout" class="d-flex gap-2">
                <button type="submit" name="method" value="cash" class="btn flex-fill border rounded text-center fs-5"><strong>Cash</strong></button>
                <button type="submit" name="method" value="gcash" class="btn flex-fill border rounded text-center fs-5">
                    <img src="/static/images/gcash_logo.png" alt="Booking Logo" width="90" height="23" class="d-inline-block me-2">
                </button>
            </form>

            <hr class="my-2">

            <div class="d-flex flex-column">
                <span class="fs-5"><strong>Credit Card</strong></span>
                <span class="fs-7">Enter your card details below.</span>
            </div>

            <form method="POST" action="/checkout" class="d-flex flex-column gap-3">
                <input type="hidden" name="method" value="card"> <div class="d-flex flex-column">
                    <span class="fs-7">Name on card</span>
                    <input autocomplete="off" autofocus class="form-control" name="name" placeholder="Enter your name" type="text" required>
                </div>
                <div class="d-flex flex-column position-relative">
                    <span class="fs-7">Card Number</span>
                    <div class="d-flex align-items-center position-relative">
                        <input autocomplete="off" autofocus class="form-control" id="cardNumber" 
                            name="c_num" placeholder="Enter your card number" type="text" maxlength="19" required>
                        <span id="cardType" class="position-absolute end-0 me-3 text-secondary fw-bold"></span>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <div class="d-flex flex-fill flex-column">
                        <span class="fs-7">Expiry Date</span>
                        <input autocomplete="off" autofocus class="form-control" name="exp_date" placeholder="MM/YY" type="text" required>
                    </div>
                    <div class="d-flex flex-fill flex-column">
                        <span class="fs-7">CVV</span>
                        <input autocomplete="off" autofocus class="form-control" name="cvv" placeholder="e.g. 123" type="text" required>
                    </div>
                </div>
                
                <button type="submit" class="btn flex-fill homepage-welcome text-center fs-5 mt-2">
                    <strong>Complete Payment</strong>
                </button>
            </form>
            
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const cardInput = document.getElementById("cardNumber");
    const cardTypeDisplay = document.getElementById("cardType");

    cardInput.addEventListener("input", function() {
        const number = cardInput.value.replace(/\s+/g, '');
        const type = detectCardType(number);
        const valid = luhnCheck(number);

        if (number.length < 13) {
            cardTypeDisplay.textContent = "";
            cardTypeDisplay.style.color = "";
            return;
        }

        if (type === "INVALID") {
            cardTypeDisplay.textContent = valid ? "Unknown" : "Invalid";
            cardTypeDisplay.style.color = valid ? "gray" : "red";
        } else {
            cardTypeDisplay.textContent = valid ? type : "Invalid";
            cardTypeDisplay.style.color = valid ? "green" : "red";
        }
    });

    function detectCardType(number) {
        if (/^4/.test(number)) return "VISA";
        if (/^5[1-5]/.test(number)) return "MASTERCARD";
        if (/^3[47]/.test(number)) return "AMEX";
        if (/^6(?:011|5)/.test(number)) return "DISCOVER";
        return "INVALID";
    }

    function luhnCheck(num) {
        if (!/^\d+$/.test(num)) return false;
        let sum = 0;
        let shouldDouble = false;
        for (let i = num.length - 1; i >= 0; i--) {
            let digit = parseInt(num[i]);
            if (shouldDouble) {
                digit *= 2;
                if (digit > 9) digit -= 9;
            }
            sum += digit;
            shouldDouble = !shouldDouble;
        }
        return sum % 10 === 0;
    }
});
</script>

{% endblock %}