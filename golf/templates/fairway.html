{% extends "layout.html" %}

{% block title %}
    Fairway Booking
{% endblock %}

{% block main %}
<div class="container-fluid px-5">
    
    <form action="/booking/fairway" method="post">
        
        <div class="row">
            <h1 class="text-left display-3 fw-bold mt-4 mb-5">
                Fairway Booking
            </h1>

            <div class="col-lg-7 col-md-12">
    
                <div class="row align-items-end mb-4">
                    
                    <div class="col-md-3">
                        <label for="date-selector" class="form-label fw-bold">Date</label>
                        <input type="date" id="date-selector" name="booking-date" class="form-select">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="time-selector" class="form-label fw-bold">Time</label>
                        <select id="time-selector" name="booking-time" class="form-select">
                            <option value="07:00">7:00 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="hole-selector" class="form-label fw-bold">Round</label>
                        <select class="form-select" name="booking-hole" id="hole-selector">
                            <option value="FULL 18">FULL 18</option>
                            <option value="9 BACK">9 BACK</option>
                            <option value="9 FRONT">9 FRONT</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <p class="h5 fw-bold mb-0" id="session-status"></p>
                    </div>
                </div>

                <hr>

                <div class="row mb-4">
                    <label for="coach-selector" class="form-label fw-bold">Coach</label>
                    <div class="col-md-12">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <select class="form-select" name="booking-coach" id="coach-selector">
                                    <option value="0">No Coach</option>
                                    {% for co in coach %}
                                        <option value="{{ co.staff_id }}" fee="{{ co.service_fee }}">
                                            {{ co.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-4">
                                <p class="h5 fw-bold mb-0" id="coach-availability"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <label for="caddie-selector" class="form-label fw-bold">Caddie</label>
                    <div class="col-md-12">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <select class="form-select" name="booking-caddie" id="caddie-selector">
                                    <option value="0">No Caddie</option>
                                    {% for ca in caddie %}
                                        <option value="{{ ca.staff_id }}" fee="{{ ca.service_fee }}">
                                            {{ ca.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-4">
                                <p class="h5 fw-bold mb-0" id="caddie-availability"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

            </div>

            <div class="col-lg-5 col-md-12">
                <div class="border rounded p-4">
                    <h3 class="mb-4">Order Summary</h3>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Round</span>
                        <strong id="hole-text">₱5000</strong>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Coach</span>
                        <strong id="coach-text">₱0</strong>
                    </div>

                    <div class="d-flex justify-content-between mb-3">
                        <span>Caddie</span>
                        <strong id="caddie-text">₱0</strong>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between h4 fw-bold my-3">
                        <span>Total</span>
                        <span id="total-price">₱5000</span>
                    </div>
                    
                    <button class="btn btn-green w-100" type="submit">Checkout Now</button>
                </div>
            </div>

        </div> 
    </form> 
</div> 

<script>
    const dateSelector = document.getElementById('date-selector');
    const timeSelector = document.getElementById('time-selector');
    const sessionStatusText = document.getElementById('session-status');
    const coachSelector = document.getElementById('coach-selector');
    const caddieSelector = document.getElementById('caddie-selector');
    const holeSelector = document.getElementById('hole-selector');

    async function checkSession() {
        const dateVal = dateSelector.value;
        const timeVal = timeSelector.value;
        const holeVal = holeSelector.value;

        if (!dateVal || !timeVal) {
            sessionStatusText.textContent = "Select Date";
            sessionStatusText.className = "h5 fw-bold text-muted mb-0 pb-1";
            return;
        }

        sessionStatusText.textContent = "Checking...";
        sessionStatusText.className = "h5 fw-bold text-muted mb-0 pb-1";

        try {
            const url = `/api/check_session_status?date=${dateVal}&time=${timeVal}&type=Fairway&holes=${holeVal}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.status === 'Available') {
                sessionStatusText.textContent = 'Available';
                sessionStatusText.className = 'h5 fw-bold text-success mb-0 pb-1';
            } else {
                sessionStatusText.textContent = data.status;
                sessionStatusText.className = 'h5 fw-bold text-danger mb-0 pb-1';
            }
        } catch (error) {
            console.error(error);
            sessionStatusText.textContent = "Error";
        }
    }

    async function checkStaff(selectorId, availabilityId, textID) {
        const selector = document.getElementById(selectorId);
        const availabilityText = document.getElementById(availabilityId);
        const staffPriceText = document.getElementById(textID);
        
        const selectedOption = selector.options[selector.selectedIndex];
        const selectedStaffId = selectedOption.value;
        const staffPrice = parseFloat(selectedOption.getAttribute('fee')) || 0;

        if (selectedStaffId === "0") {
            availabilityText.textContent = ""; 
            staffPriceText.textContent = `₱0`;
            updateTotal();
            return; 
        }

        const dateVal = dateSelector.value;
        const timeVal = timeSelector.value;

        if (!dateVal || !timeVal) {
            availabilityText.textContent = "Select Date & Time";
            availabilityText.className = "h5 fw-bold text-muted mb-0";
            staffPriceText.textContent = `₱${staffPrice}`;
            updateTotal();
            return;
        }

        // Call the API
        availabilityText.textContent = "Checking..."; // Loading state
        availabilityText.className = "h5 fw-bold text-muted mb-0";

        try {
            const datetime = `${dateVal} ${timeVal}:00`;
            const response = await fetch(`/api/check_staff_availability?staff_id=${selectedStaffId}&datetime=${datetime}`);
            const data = await response.json();

            if (data.available) {
                availabilityText.textContent = 'Available';
                availabilityText.className = 'h5 fw-bold text-success mb-0';
            } else {
                availabilityText.textContent = 'Occupied'; 
                availabilityText.className = 'h5 fw-bold text-danger mb-0';
            }
        } catch (error) {
            console.error(error);
            availabilityText.textContent = 'Error'; 
        }
        staffPriceText.textContent = `₱${staffPrice}`;
        updateTotal();
    }

    function getHolePrice() {
        const selectedHole = holeSelector.value;
        const holeText = document.getElementById('hole-text');
        let holePrice = 0;

        if (selectedHole === 'FULL 18') {
            holePrice = 5000;
        } else {
            holePrice = 3000;
        }
        
        holeText.textContent = `₱${holePrice}`;
        return holePrice;
    }

    function updateTotal() {
        const totalText = document.getElementById('total-price');
        

        const roundPrice = getHolePrice();

        const coachOption = coachSelector.options[coachSelector.selectedIndex];
        const coachPrice = (coachOption.value !== "0") ? parseFloat(coachOption.getAttribute('fee')) : 0;

        const caddieOption = caddieSelector.options[caddieSelector.selectedIndex];
        const caddiePrice = (caddieOption.value !== "0") ? parseFloat(caddieOption.getAttribute('fee')) : 0;

        const total = roundPrice + coachPrice + caddiePrice;
        totalText.textContent = `₱${total}`;
    }

    // EVENT LISTENERS
    
    // If Hole changes, just update total
    holeSelector.addEventListener('change', () => {
        updateTotal();
        checkSession();
    });

    // If Staff changes, check availability
    coachSelector.addEventListener('change', () => {
        checkStaff('coach-selector', 'coach-availability', 'coach-text');
    });
    caddieSelector.addEventListener('change', () => {
        checkStaff('caddie-selector', 'caddie-availability', 'caddie-text');
    });

    // If Date/Time changes, re-check BOTH staff members
    dateSelector.addEventListener('change', () => {
        checkStaff('coach-selector', 'coach-availability', 'coach-text');
        checkStaff('caddie-selector', 'caddie-availability', 'caddie-text');
        checkSession();
    });
    timeSelector.addEventListener('change', () => {
        checkStaff('coach-selector', 'coach-availability', 'coach-text');
        checkStaff('caddie-selector', 'caddie-availability', 'caddie-text');
        checkSession();
    });

    updateTotal();
    checkSession();
    checkStaff('coach-selector', 'coach-availability', 'coach-text');
    checkStaff('caddie-selector', 'caddie-availability', 'caddie-text');
</script>
{% endblock %}
