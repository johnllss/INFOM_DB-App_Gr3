{% extends "layout.html" %}

{% block title %}
    Reports
{% endblock %}

{% block main %}
    <div class="container">
        <h1 class="my-5"><strong>Admin Reports</strong></h1>

        <div class="card mb-5 border-0 shadow-sm">
            <div class="card-body d-flex align-items-center" style="background-color: #f8f9fa;">
                <h5 class="card-title me-3 mb-0" style="color: #2e944b;">
                    <i class="bi bi-funnel-fill"></i> Filter Reports
                </h5>
                
                <form method="GET" action="/reports" class="d-flex align-items-center">
                    <label for="year-selector" class="form-label fw-bold me-2 mb-0">Select Year:</label>
                    <select name="year" id="year-selector" class="form-select w-auto border-success" onchange="this.form.submit()"> 
                        {% for year in selectable_years %}
                            <option value="{{ year }}" {% if year == admin_selected_year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        <h2 class="mt-5">Yearly Sales Performance</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="text-white" style="background-color: #2e944b;">
                    <tr>
                        <th>Year</th>
                        <th>Rev. (Sessions/Items)</th>
                        <th>Rev. (Memberships)</th>
                        <th>Total Renewals</th>
                        <th>Total Sessions</th>
                        <th>Unique Customers</th>
                    </tr>
                </thead>
                <tbody>
                    {% if yearly_sales_report %}
                        {% for row in yearly_sales_report %}
                        <tr>
                            <td>{{ row.year }}</td>
                            <td>{{ row.session_items | php }}</td>
                            <td>{{ row.membership_subscriptions | php }}</td>
                            <td>{{ row.renewal_rate }}</td>
                            <td>{{ row.total_sessions }}</td>
                            <td>{{ row.unique_customers }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">No sales data found for {{ admin_selected_year }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-5">Monthly Sales Performance</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="text-white" style="background-color: #2e944b;">
                    <tr>
                        <th>Month</th>
                        <th>Rev. (Sessions/Items)</th>
                        <th>Rev. (Memberships)</th>
                        <th>Total Renewals</th>
                        <th>Total Sessions</th>
                        <th>Unique Customers</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in monthly_sales_report %}
                    <tr>
                        <td>{{ row.month }}</td>
                        <td>{{ row.session_items }}</td>
                        <td>{{ row.membership_subscriptions }}</td>
                        <td>{{ row.renewal_rate }}</td>
                        <td>{{ row.total_sessions }}</td>
                        <td>{{ row.unique_customers }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center">No sales data found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-5">Yearly Staff Performance ({{ admin_selected_year }})</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="text-white" style="background-color: #2e944b;">
                    <tr>
                        <th>Staff Name</th>
                        <th>Role</th>
                        <th>Total Sessions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if yearly_staff_report %}
                        {% for row in yearly_staff_report %}
                        <tr>
                            <td>{{ row.name }}</td>
                            <td>{{ row.role }}</td>
                            <td>{{ row.total_sessions }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">No staff data for {{ admin_selected_year }}.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-5">Quarterly Staff Performance ({{ admin_selected_year }})</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="text-white" style="background-color: #2e944b;">
                    <tr>
                        <th>Staff Name</th>
                        <th>Role</th>
                        <th>Quarter</th>
                        <th>Total Sessions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if quarterly_staff_report %}
                        {% for row in quarterly_staff_report %}
                        <tr>
                            <td>{{ row.name }}</td>
                            <td>{{ row.role }}</td>
                            <td>{{ row.session_quarter.split('-')[1] }}</td>
                            <td>{{ row.total_sessions }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">No quarterly data for {{ admin_selected_year }}.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-5">Inventory Report ({{ admin_selected_year }})</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="text-white" style="background-color: #2e944b;">
                    <tr>
                        <th>Item Name</th>
                        <th>Total Purchases/Rent</th>
                        <th>Total Revenue</th>
                        <th>Rental/Sale Ratio %</th>
                        <th>Rental Utilization Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% if inventory_report %}
                        {% for item in inventory_report %}
                        <tr>
                            <td>{{ item.Item_Name }}</td>
                            <td>{{ item.Total_Units_Bought }}</td>
                            <td>{{ item.Total_Revenue }}</td>
                            <td>{{ item.Rent_Percentage }}%</td>
                            
                            <td>
                                {% if item.Utilization_Rate is not none %}
                                    <span class="badge 
                                        {% if item.Utilization_Rate >= 70 %}bg-success
                                        {% elif item.Utilization_Rate >= 40 %}bg-warning text-dark
                                        {% else %}bg-danger
                                        {% endif %}">
                                        {{ item.Utilization_Rate }}%
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center">No inventory data for {{ admin_selected_year }}</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-5">Customer Value Report ({{ admin_selected_year }})</h2>
        <div class="table-responsive mb-5">
            <table class="table table-striped table-hover">
                <thead class="text-white" style="background-color: #2e944b;">
                    <tr>
                        <th>Customer Name</th>
                        <th>Email</th>
                        <th>Membership Tier</th>
                        <th>Sessions Attended</th>
                        <th>Total Spent</th>
                        <th>Loyalty Points</th>
                    </tr>
                </thead>
                <tbody>
                    {% if customer_report %}
                        {% for row in customer_report %}
                        <tr>
                            <td>{{ row.full_name }}</td>
                            <td>{{ row.email }}</td>
                            <td>{{ row.membership_tier }}</td>
                            <td>{{ row.total_sessions_attended }}</td>
                            <td>{{ row.total_amount_spent | php }}</td>
                            <td>{{ row.accumulated_loyalty_points }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">No customer data available for {{ admin_selected_year }}.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

    </div>
{% endblock %}